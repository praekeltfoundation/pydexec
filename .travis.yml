sudo: required
services:
    - docker
# Haven't needed this before to get Docker to work (???)
# https://github.com/travis-ci/travis-ci/issues/5448
dist: trusty

language: python
env:
  - DOCKER_IMAGE=python:2.7-slim
  - DOCKER_IMAGE=python:3.5-slim
  - DOCKER_IMAGE=pypy:2-5.4.1-slim

install:
  - docker pull $DOCKER_IMAGE
  - pip install codecov

before_script:
  - if [[ -z "$NO_COVERAGE" ]]; then COV_OPT='--cov'; fi
  - |
    SCRIPT="set -x \
      && pip install --no-cache -r requirements-dev.txt \
      && pytest --cov --cov-report xml \
      && flake8 ."
script:
  # Run tests inside a container to get a vaguely consistent environment
  - docker run --rm -v "$(pwd)":/pydexec -w /pydexec $DOCKER_IMAGE /bin/sh -c "$SCRIPT"

after_success:
  - codecov
